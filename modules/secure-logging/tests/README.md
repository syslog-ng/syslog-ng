# Unit Test of module secure-logging

For unit tests, the unit test framework Criterion is used.
Secure-logging provides unit tests in file
modules/secure-logging/tests/test_secure_logging.


# Criterion

https://criterion.readthedocs.io/en/master/intro.html


# Full build process and example configuration

## autogen

The following steps do describe how syslog-ng can be built and how unit
tests are triggered.
From a terminal in the syslog-ng base folder run these commands:
```
./autogen.sh

mkdir build

cd build

../configure --prefix=$HOME/Software/install --enable-debug --enable-manpages --disable-java --disable-python --disable-python-modules --with-ivykis=system --with-jsonc=yes --enable-stomp=no --enable-sql=no

make

make install

make check
```

## cmake

Parallel to the classic build system by autogen.sh (autoconf), there is also cmake environment available.
Here the make file is created by cmake.
Example: In the syslog-ng source root directory call:

```
mkdir cmake_build

cd cmake_build

cmake \
    -DCMAKE_C_COMPILER=gcc \
    -DCMAKE_CXX_COMPILER=g++ \
    -DIVYKIS_SOURCE=system \
    -DJSONC_SOURCE=system  \
    -DENABLE_MANPAGES=on   \
    -DENABLE_PYTHON=off   \
    -DENABLE_APPMODEL=on   \
    -DENABLE_PYTHON_MODULES=off \
    -DENABLE_JAVA=off           \
    -DENABLE_PYTHON_JAVA=off    \
    -DENABLE_CLOUD_AUTH=off     \
    -DENABLE_CLOUD_AUTH_CURL=off   \
    -DENABLE_AZURE_AUTH_HEADER=off \
    -DENABLE_STOMP=off             \
    -DENABLE_EXAMPLE_FILTERX_FUNC=off \
    -DENABLE_EXAMPLE_MODULES=off      \
    -DENABLE_XML=off      \
    -DENABLE_STARDATE=off      \
    -DCMAKE_BUILD_TYPE=Debug          \
    -DCMAKE_INSTALL_PREFIX=$HOME/Software/install \
    ..

make

make install

make check
```

## make install

With **make install** a folder structure is created inside the folder, given by
the configure script by option **--prefix** where build artefacts are copied into.

See configure example above:
  --prefix=$HOME/Software/install

## make check

With **make check** the unit tests are executed.
The unit tests do use temporarly folders and files that are deleted at the end
of each test.
When needed, extra logging is available through the file test_secure_logging.log
which can be found in the build folder in:
<syslog-ng-source>/build/modules/secure-logging/tests/
when the user created a build folder inside the source folder and uses above
described build instructions.


# Test of Command Line Interface (CLI) tools

Some of the CLI tools can not be tested by unit tests directly.
Shell scripts are provided therefore and they are called from inside unit tests.

Binaries will be updated from source by **make install**

Each test script uses temporarily the folder /tmp/test/slog/ and
all data is deleted at the end of each test.

The syslog-ng configuration is given by file syslog-ng-test-udp-c.conf and
will be copied by a script into the temporary test folder.

When needed for debugging purpose, the content of the test folder can be copied
into into the users home folder, see script variables HOME_BACKUP and
COPY_TO_HOME_BACKUP (existing data is deleted or overwritten without asking).

NOTE: In file test_secure_logging.c there is a preprocessor used:
**RUN_CLI_SMOKETEST**
When this is available and set to 1, tests based on shell scripts are
triggered.
Later this preprocessor might be defined in a different place.


## cli01_syslog.sh

Smoke test of CLI tools **syslog-ng**, **syslog-ng-cli**, **slogkey**
and **slogverify**.
Keys and log entries are generated by the tool.


## cli02_crypt_verify.sh

Smoke test of CLI tools **slogkey**, **slogencrypt** and **slogverify**.
Keys and log entries are generated by the tool.


## cli03_loggen.sh

Smoke test of CLI tool **loggen**, which uses **syslog-ng** and **syslog-ng-cli**.
Keys and log entries are generated by the tool.


## cli04_loggen_file.sh

Smoke test like cli03_loggen.sh but using a user prepared file as input for log entries.
Note: The path of the file must be provided in the script and the file must be
compliant to RFC5424.
There is a small log file provided that will be used automatically.
PAYLOAD=payload_utf8_2048.txt
PAYLOAD_FILE=${TEST}/${PAYLOAD}


## cli06_syslog.sh

Like cli01_syslog.sh but here, the syslog-ng daemon is not stopped and restarted
every log.
Keys and log entries are generated by the tool.


## Helper scripts

### get_git_info.sh
Shows current git branch state.

### start_syslog-ng.sh
Standalone script to start syslog-ng daemon for manual tests.

### stop_syslog-ng.sh
Standalone script to stop syslog-ng daemon for manual tests.

### test_secure_logging.c
Criterion unit test that do also call the test shell scripts.

### get_prefix.sh
Get the syslog-ng install directory which should be available when autogen.sh or cmake
base build has successfully finished.
This script is called in test scripts.

### update_conf_path.sh
For each test a syslog-ng.conf file is copied into the its folder.
Each script has its own folder and therefore syslog-ng.conf, based on the template
syslog-ng-test-udp-nc.conf, gets the corresponding path by updating its variable
@define mypath "/tmp/test_slog/data"
