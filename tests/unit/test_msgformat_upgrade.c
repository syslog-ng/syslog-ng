#include "syslog-ng.h"
#include "serialize.h"
#include "misc.h"
#include "logmsg.h"
#include "apphook.h"

#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <string.h>

/* serialized message in syslog-ng 2.1 format, version ID 1 */
const guint8 msg_serialized_21[] =
{
  0x01, 0x00, 0xbe, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x02, 0x0a, 0x0a, 0x0a, 0x0a, 0xf2, 0x03, 0x46,
  0x22, 0x7c, 0xcd, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1c, 0x20, 0x48, 0x84, 0xe7, 0x94, 0x00,
  0x0a, 0x69, 0xa1, 0x00, 0x00, 0x1c, 0x20, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x0d, 0x25, 0x50, 0x49, 0x58, 0x2d,
  0x36, 0x2d, 0x33, 0x30, 0x32, 0x30, 0x31, 0x34,
  0x00, 0x00, 0x00, 0x8a, 0x25, 0x50, 0x49, 0x58,
  0x2d, 0x36, 0x2d, 0x33, 0x30, 0x32, 0x30, 0x31,
  0x34, 0x3a, 0x20, 0x54, 0x65, 0x61, 0x72, 0x64,
  0x6f, 0x77, 0x6e, 0x20, 0x54, 0x43, 0x50, 0x20,
  0x63, 0x6f, 0x6e, 0x6e, 0x65, 0x63, 0x74, 0x69,
  0x6f, 0x6e, 0x20, 0x31, 0x36, 0x38, 0x38, 0x34,
  0x33, 0x38, 0x20, 0x66, 0x6f, 0x72, 0x20, 0x62,
  0x6c, 0x6f, 0x6f, 0x6d, 0x62, 0x65, 0x72, 0x67,
  0x2d, 0x6e, 0x65, 0x74, 0x3a, 0x31, 0x2e, 0x32,
  0x2e, 0x33, 0x2e, 0x34, 0x2f, 0x38, 0x32, 0x39,
  0x34, 0x20, 0x74, 0x6f, 0x20, 0x69, 0x6e, 0x73,
  0x69, 0x64, 0x65, 0x3a, 0x35, 0x2e, 0x36, 0x2e,
  0x37, 0x2e, 0x38, 0x2f, 0x33, 0x36, 0x33, 0x39,
  0x20, 0x64, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f,
  0x6e, 0x20, 0x30, 0x3a, 0x30, 0x37, 0x3a, 0x30,
  0x31, 0x20, 0x62, 0x79, 0x74, 0x65, 0x73, 0x20,
  0x31, 0x36, 0x39, 0x37, 0x35, 0x20, 0x54, 0x43,
  0x50, 0x20, 0x46, 0x49, 0x4e, 0x73, 0x00
};

/* syslog-ng 3.0.1, version ID 10 */
const guint8 msg_serialized_version10[] =
{
  0x0a, 0x00, 0x00, 0x00, 0xbe, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x02, 0x0a, 0x0a, 0x0a, 0x0a, 0xf2,
  0x03, 0x00, 0x00, 0x00, 0x00, 0x46, 0x22, 0x7c,
  0xcd, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c,
  0x20, 0x00, 0x00, 0x00, 0x00, 0x49, 0x65, 0xcc,
  0x7d, 0x00, 0x0b, 0x16, 0xb6, 0x00, 0x00, 0x0e,
  0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x0d, 0x25, 0x50, 0x49,
  0x58, 0x2d, 0x36, 0x2d, 0x33, 0x30, 0x32, 0x30,
  0x31, 0x34, 0x00, 0x00, 0x00, 0x7b, 0x54, 0x65,
  0x61, 0x72, 0x64, 0x6f, 0x77, 0x6e, 0x20, 0x54,
  0x43, 0x50, 0x20, 0x63, 0x6f, 0x6e, 0x6e, 0x65,
  0x63, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x31, 0x36,
  0x38, 0x38, 0x34, 0x33, 0x38, 0x20, 0x66, 0x6f,
  0x72, 0x20, 0x62, 0x6c, 0x6f, 0x6f, 0x6d, 0x62,
  0x65, 0x72, 0x67, 0x2d, 0x6e, 0x65, 0x74, 0x3a,
  0x31, 0x2e, 0x32, 0x2e, 0x33, 0x2e, 0x34, 0x2f,
  0x38, 0x32, 0x39, 0x34, 0x20, 0x74, 0x6f, 0x20,
  0x69, 0x6e, 0x73, 0x69, 0x64, 0x65, 0x3a, 0x35,
  0x2e, 0x36, 0x2e, 0x37, 0x2e, 0x38, 0x2f, 0x33,
  0x36, 0x33, 0x39, 0x20, 0x64, 0x75, 0x72, 0x61,
  0x74, 0x69, 0x6f, 0x6e, 0x20, 0x30, 0x3a, 0x30,
  0x37, 0x3a, 0x30, 0x31, 0x20, 0x62, 0x79, 0x74,
  0x65, 0x73, 0x20, 0x31, 0x36, 0x39, 0x37, 0x35,
  0x20, 0x54, 0x43, 0x50, 0x20, 0x46, 0x49, 0x4e,
  0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x03, 0x54,
  0x65, 0x61, 0x00, 0x00, 0x00, 0x00, 0x01, 0x54,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x65, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x61, 0x00, 0x00, 0x00, 0x00,
  0x08, 0x68, 0x65, 0x68, 0x65, 0x68, 0x65, 0x68,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00,
};

const guint8 msg_serialized_version11[331] = {
  0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbe, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x02, 0x0a, 0x0a, 0x0a,
  0x0a, 0xf2, 0x03, 0x00, 0x00, 0x00, 0x00, 0x46,
  0x22, 0x7c, 0xcd, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x1c, 0x20, 0x00, 0x00, 0x00, 0x00, 0x49,
  0x65, 0xcc, 0x7d, 0x00, 0x0b, 0x16, 0xb6, 0x00,
  0x00, 0x0e, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x25,
  0x50, 0x49, 0x58, 0x2d, 0x36, 0x2d, 0x33, 0x30,
  0x32, 0x30, 0x31, 0x34, 0x00, 0x00, 0x00, 0x7b,
  0x54, 0x65, 0x61, 0x72, 0x64, 0x6f, 0x77, 0x6e,
  0x20, 0x54, 0x43, 0x50, 0x20, 0x63, 0x6f, 0x6e,
  0x6e, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x20,
  0x31, 0x36, 0x38, 0x38, 0x34, 0x33, 0x38, 0x20,
  0x66, 0x6f, 0x72, 0x20, 0x62, 0x6c, 0x6f, 0x6f,
  0x6d, 0x62, 0x65, 0x72, 0x67, 0x2d, 0x6e, 0x65,
  0x74, 0x3a, 0x31, 0x2e, 0x32, 0x2e, 0x33, 0x2e,
  0x34, 0x2f, 0x38, 0x32, 0x39, 0x34, 0x20, 0x74,
  0x6f, 0x20, 0x69, 0x6e, 0x73, 0x69, 0x64, 0x65,
  0x3a, 0x35, 0x2e, 0x36, 0x2e, 0x37, 0x2e, 0x38,
  0x2f, 0x33, 0x36, 0x33, 0x39, 0x20, 0x64, 0x75,
  0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x30,
  0x3a, 0x30, 0x37, 0x3a, 0x30, 0x31, 0x20, 0x62,
  0x79, 0x74, 0x65, 0x73, 0x20, 0x31, 0x36, 0x39,
  0x37, 0x35, 0x20, 0x54, 0x43, 0x50, 0x20, 0x46,
  0x49, 0x4e, 0x73, 0x00, 0x00, 0x00, 0x0b, 0x50,
  0x72, 0x6f, 0x63, 0x65, 0x73, 0x73, 0x20, 0x49,
  0x44, 0x00, 0x00, 0x00, 0x00, 0x0b, 0x4d, 0x65,
  0x73, 0x73, 0x61, 0x67, 0x65, 0x20, 0x49, 0x44,
  0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x03, 0x54,
  0x65, 0x61, 0x00, 0x00, 0x00, 0x00, 0x01, 0x54,
  0x00, 0x00, 0x00, 0x00, 0x01, 0x65, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x61, 0x00, 0x00, 0x00, 0x00,
  0x08, 0x68, 0x65, 0x68, 0x65, 0x68, 0x65, 0x68,
  0x65, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x07, 0x45, 0x6c, 0x65,
  0x6d, 0x65, 0x6e, 0x74, 0x00, 0x00, 0x00, 0x09,
  0x50, 0x61, 0x72, 0x61, 0x6d, 0x4e, 0x61, 0x6d,
  0x65, 0x00, 0x00, 0x00, 0x0a, 0x50, 0x61, 0x72,
  0x61, 0x6d, 0x56, 0x61, 0x6c, 0x75, 0x65, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00,
};

#define TEST_ASSERT(x, format, value, expected)		\
  do 				\
    { 				\
        if (!(x))		\
          {			\
            fprintf(stderr, "Testcase failed; msg='%s', cond='%s', value=" format ", expected=" format "\n", testcase_name, #x, value, expected); \
            exit(1);		\
          }			\
    }				\
  while (0)

unsigned long
absolute_value(signed long diff)
{
  if (diff < 0)
    return -diff;
  else
    return diff;
}


void
test_msg_read(const gchar *testcase_name,
              const guint8 *serialized_msg, gsize serialized_msg_len,
              gint expected_pri,
              unsigned long expected_stamp_sec,
              unsigned long expected_stamp_usec,
              unsigned long expected_stamp_ofs,
              const gchar *expected_host,
              const gchar *expected_program,
              const gchar *expected_msg,
              const gchar *expected_sd_str,
              const gchar *expected_pid,
              const gchar *expected_msgid,
              const gchar *expected_sd_pairs[][2])

{
  GString *serialized = g_string_sized_new(serialized_msg_len + 1);
  SerializeArchive *sa;
  LogMessage *logmsg;
  time_t now;
  GString *sd_str = g_string_sized_new(0);

  g_string_assign_len(serialized, (gchar *) serialized_msg, serialized_msg_len);
  sa = serialize_string_archive_new(serialized);
  logmsg = log_msg_new_empty();
  if (!log_msg_read(logmsg, sa))
    {
      fprintf(stderr, "Error deserializing stored message\n");
      exit(1);
    }
  serialize_archive_free(sa);
  g_string_free(serialized, TRUE);

  TEST_ASSERT(logmsg->pri == expected_pri, "%d", logmsg->pri, expected_pri);
  if (expected_stamp_sec)
    {
      if (expected_stamp_sec != 1)
        {
          TEST_ASSERT(logmsg->timestamps[LM_TS_STAMP].tv_sec == expected_stamp_sec, "%d", (int) logmsg->timestamps[LM_TS_STAMP].tv_sec, (int) expected_stamp_sec);
        }
      TEST_ASSERT(logmsg->timestamps[LM_TS_STAMP].tv_usec == expected_stamp_usec, "%d", (int) logmsg->timestamps[LM_TS_STAMP].tv_usec, (int) expected_stamp_usec);
      TEST_ASSERT(logmsg->timestamps[LM_TS_STAMP].zone_offset == expected_stamp_ofs, "%d", (int) logmsg->timestamps[LM_TS_STAMP].zone_offset, (int) expected_stamp_ofs);
    }
  else
    {
      time(&now);
      TEST_ASSERT(absolute_value(logmsg->timestamps[LM_TS_STAMP].tv_sec - now) < 1, "%d", 0, 0);
    }
  TEST_ASSERT(strcmp(log_msg_get_value(logmsg, LM_V_HOST, NULL), expected_host) == 0, "%s", log_msg_get_value(logmsg, LM_V_HOST, NULL), expected_host);
  TEST_ASSERT(strcmp(log_msg_get_value(logmsg, LM_V_PROGRAM, NULL), expected_program) == 0, "%s", log_msg_get_value(logmsg, LM_V_PROGRAM, NULL), expected_program);
  TEST_ASSERT(strcmp(log_msg_get_value(logmsg, LM_V_MESSAGE, NULL), expected_msg) == 0, "%s", log_msg_get_value(logmsg, LM_V_MESSAGE, NULL), expected_msg);
  TEST_ASSERT(!expected_pid || strcmp(log_msg_get_value(logmsg, LM_V_PID, NULL), expected_pid) == 0, "%s", log_msg_get_value(logmsg, LM_V_PID, NULL), expected_pid);
  TEST_ASSERT(!expected_msgid || strcmp(log_msg_get_value(logmsg, LM_V_MSGID, NULL), expected_msgid) == 0, "%s", log_msg_get_value(logmsg, LM_V_MSGID, NULL), expected_msgid);

  /* SD elements */
  log_msg_format_sdata(logmsg, sd_str, 0);
  TEST_ASSERT(!expected_sd_str || strcmp(sd_str->str, expected_sd_str) == 0, "%s", sd_str->str, expected_sd_str);

  log_msg_unref(logmsg);
  g_string_free(sd_str, TRUE);
}

int
main()
{
  app_startup();
  test_msg_read("upgrade from 2.1 (version 1)", msg_serialized_21, sizeof(msg_serialized_21),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           NULL, NULL, NULL, NULL);
  test_msg_read("upgrade from 3.0.1 (version 10)", msg_serialized_version10, sizeof(msg_serialized_version10),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           NULL, NULL, NULL, NULL);
  test_msg_read("upgrade from 3.1 to 3.1 (version 11 to 12)", msg_serialized_version11, sizeof(msg_serialized_version11),
           190,
           1176665293, 0, 7200,
           "",
           "%PIX-6-302014",
           "Teardown TCP connection 1688438 for bloomberg-net:1.2.3.4/8294 to inside:5.6.7.8/3639 duration 0:07:01 bytes 16975 TCP FINs",
           "[Element ParamName=\"ParamValue\"]", "Process ID", "Message ID", NULL);
  app_shutdown();
  return 0;
}
